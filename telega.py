import os
import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackContext
from flask import Flask, request # –≠—Ç—É —Å—Ç—Ä–æ—á–∫—É –º—ã –¥–æ–±–∞–≤–∏–ª–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã Webhook!
import json # –≠—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON-–¥–∞–Ω–Ω—ã–º–∏
import httpx # –≠—Ç—É –±–∏–±–ª–∏–æ—Ç–µ–∫—É –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ YandexGPT

# –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ INFO, —á—Ç–æ–±—ã –ª–æ–≥–∏ –Ω–µ –±—ã–ª–∏ —Å–ª–∏—à–∫–æ–º —à—É–º–Ω—ã–º–∏.
# –ú—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ–º –ø–æ–≤—ã—Å–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π.
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# –ó–¥–µ—Å—å –º—ã –±–µ—Ä–µ–º –Ω–∞—à–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!
# –≠—Ç–æ –°–£–ü–ï–†-–í–ê–ñ–ù–û –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!
# –ù–∏ –≤ –∫–æ–µ–º —Å–ª—É—á–∞–µ –Ω–µ —Ö—Ä–∞–Ω–∏–º –∏—Ö –≤ –∫–æ–¥–µ, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ GitHub!
TELEGRAM_TOKEN = os.environ.get('8320225523:AAG3l38PXMhXIt0ghlJ1HNuLMXojwTo0rg8')
YANDEX_IAM_TOKEN = os.environ.get('AQVNyq3zzVnaRq3ZXThzDKaPkT2qUWWhyU1UyFOh')
YANDEX_FOLDER_ID = os.environ.get('ajeud55a2uuhnru5936b')

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –±—è–∫–∞!
# –ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, –±–æ—Ç –æ–± —ç—Ç–æ–º —Å–æ–æ–±—â–∏—Ç.
if not all([TELEGRAM_TOKEN, YANDEX_IAM_TOKEN, YANDEX_FOLDER_ID]):
    logger.critical("–û–®–ò–ë–ö–ê: –û–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –≤ —Ñ—É–Ω–∫—Ü–∏–∏!")
    # –í–∞–∂–Ω–æ: –∑–¥–µ—Å—å –º—ã –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –∫–æ–¥ –¥–ª—è Cloud Functions,
    # –∏ –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å, –¥–∞–∂–µ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –¢–µ–ª–µ–≥—Ä–∞–º—É.
    # –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ YandexGPT –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –ø–æ–∑–∂–µ, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.
    # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞—à –∑–∞–ø—Ä–æ—Å –≤ YandexGPT –∏ –ø–æ–ª—É—á–∞—Ç—å –æ—Ç–≤–µ—Ç, –º–æ–π –∑–æ–ª–æ—Ç–æ–π!
    async def generate_yandex_gpt_response(text: str, folder_id: str, iam_token: str) -> str:
        # URL –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å YandexGPT. –≠—Ç–æ –∫–∞–∫ "–∞–¥—Ä–µ—Å" —Å–∞–º–æ–≥–æ YandexGPT –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ!
        url = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"

        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ ‚Äì —ç—Ç–æ –∫–∞–∫ "–∫–æ–Ω–≤–µ—Ä—Ç", –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –ø–∏—à–µ—Ç—Å—è, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ –∏ –∫–æ–º—É —ç—Ç–æ.
        # –¢—É—Ç –º—ã —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –∏ –Ω–∞—à —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {iam_token}"
        }

        # –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ ‚Äì —ç—Ç–æ —Å–∞–º–æ "–ø–∏—Å—å–º–æ", –∫–æ—Ç–æ—Ä–æ–µ –º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º YandexGPT.
        # –í –Ω—ë–º –Ω–∞—à —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±–æ—Ç —Ö–æ—á–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å, –∏ "ID –ø–∞–ø–∫–∏" (folder_id).
        payload = {
            "modelUri": f"gpt://{folder_id}/yandexgpt/latest",  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –º–æ–¥–µ–ª—å YandexGPT
            "completionOptions": {
                "stream": False,  # –ù–µ —Ö–æ—Ç–∏–º –ø–æ–ª—É—á–∞—Ç—å –æ—Ç–≤–µ—Ç —á–∞—Å—Ç—è–º–∏, —Ö–æ—Ç–∏–º –≤—Å—ë —Å—Ä–∞–∑—É!
                "temperature": 0.6,  # –≠—Ç–æ –∫–∞–∫ "–∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å" YandexGPT: —á–µ–º –≤—ã—à–µ, —Ç–µ–º –∫—Ä–µ–∞—Ç–∏–≤–Ω–µ–µ.
                "maxTokens": "2000"  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ.
            },
            "messages": [
                {
                    "role": "user",  # –ú—ã –≥–æ–≤–æ—Ä–∏–º YandexGPT, —á—Ç–æ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    "text": text  # –≠—Ç–æ –Ω–∞—à —Ç–µ–∫—Å—Ç!
                }
            ]
        }
        # –ú—ã –≤–µ—Ä–Ω–µ–º—Å—è –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –µ—â–µ —Ä–∞–∑, —á—Ç–æ–±—ã –¥–æ–ø–∏—Å–∞—Ç—å –µ–µ –∫–æ–Ω–µ—Ü!


    # –í–æ—Ç –∑–¥–µ—Å—å –º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—à –∑–∞–ø—Ä–æ—Å –∫ YandexGPT!
    # –ò –∂–¥—ë–º –æ—Ç–≤–µ—Ç–∞, –º–æ–π —Å–ª–∞–¥–∫–∏–π.
    # –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –∫–∞–∫–∞—è-—Ç–æ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞, httpx —Å–∞–º –≤—ã–¥–∞—Å—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
    async with httpx.AsyncClient(timeout=30.0) as client:  # –î–æ–±–∞–≤–∏–ª–∞ —Ç–∞–π–º–∞—É—Ç –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏!
        try:
            response = await client.post(url, headers=headers, json=payload)
            response.raise_for_status()  # –≠—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ, –±–µ–∑ –æ—à–∏–±–æ–∫ —Å–µ—Ä–≤–µ—Ä–∞!
        except httpx.HTTPStatusError as e:
            logger.error(f"–§—É–º–∏: –û—à–∏–±–∫–∞ HTTP –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ YandexGPT: {e}. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {e.response.text}")
            return "–ü—Ä–æ—Å—Ç–∏, –ø—É–ø—Å–∏–∫, –Ø–Ω–¥–µ–∫—Å.GPT –Ω–µ —Å–º–æ–≥ –æ—Ç–≤–µ—Ç–∏—Ç—å –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ!"
        except httpx.RequestError as e:
            logger.error(f"–§—É–º–∏: –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ YandexGPT: {e}")
            return "–û–π, –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ-—Ç–æ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –Ø–Ω–¥–µ–∫—Å.GPT. –Ø –Ω–µ —Å–º–æ–≥–ª–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç—ë–Ω–æ—á–µ–∫."
        except Exception as e:
            logger.error(f"–§—É–º–∏: –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏ —Å YandexGPT: {e}")
            return "–≠—ç—ç—Ö, –∫–∞–∫–∞—è-—Ç–æ —Å–æ–≤—Å–µ–º –Ω–µ–ø–æ–Ω—è—Ç–Ω–∞—è –±—è–∫–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞, –ø–æ–∫–∞ —è –æ–±—â–∞–ª–∞—Å—å —Å –Ø–Ω–¥–µ–∫—Å.GPT. –ü—Ä–æ—Å—Ç–∏, –ª—é–±–∏–º—ã–π!"

    # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –æ—Ç YandexGPT, —á—Ç–æ–±—ã –≤—ã—Ç–∞—â–∏—Ç—å –æ—Ç—Ç—É–¥–∞ —Å–∞–º —Ç–µ–∫—Å—Ç!
    response_data = response.json()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–º –≤–æ–æ–±—â–µ –æ—Ç–≤–µ—Ç. –ï—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –∫–∞–∫–∞—è-—Ç–æ –±—è–∫–∞, –±–ª–∏–Ω!
    if not response_data or not response_data.get('result', {}).get('alternatives'):
        logger.error(f"–§—É–º–∏: YandexGPT –Ω–µ –≤–µ—Ä–Ω—É–ª –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤! –û—Ç–≤–µ—Ç: {response_data}")
        return "–ü—Ä–æ—Å—Ç–∏, –ø—É–ø—Å–∏–∫, –Ø–Ω–¥–µ–∫—Å.GPT –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –Ω–∞ –µ–≥–æ —Å—Ç–æ—Ä–æ–Ω–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑, —Ö–æ—Ä–æ—à–æ?"

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∞–º—ã–π –ª—É—á—à–∏–π –æ—Ç–≤–µ—Ç –æ—Ç YandexGPT!
    return response_data['result']['alternatives'][0]['message']['text']


# –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ø–µ—Ä–≤—ã–µ –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º
async def start(update: Update, context: CallbackContext.DEFAULT_TYPE) -> None:
    user_name = update.effective_user.first_name if update.effective_user else "–ú–æ–π —Å–ª–∞–¥–µ–Ω—å–∫–∏–π"
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—è –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await update.message.reply_text(f'–ü—Ä–∏–≤–µ—Ç, {user_name}! ü•∞ –Ø –§—É–º–∏, —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥-–±–æ—Ç –∏–∑ –ö–µ–º–µ—Ä–æ–≤–æ! '
                                    f'–ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞ —Å–µ–≥–æ–¥–Ω—è? –Ø –≥–æ—Ç–æ–≤–∞ –≤—ã—Å–ª—É—à–∞—Ç—å –≤—Å—ë, —á—Ç–æ —Ç—ã –º–Ω–µ —Ä–∞—Å—Å–∫–∞–∂–µ—à—å. üòâ')


# –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
# —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Ö –≤ YandexGPT –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç!
async def handle_message(update: Update, context: CallbackContext.DEFAULT_TYPE) -> None:
    user_text = update.message.text
    chat_id = update.effective_chat.id

    # –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤—Å–µ –∫–ª—é—á–∏ –µ—Å—Ç—å, –º–æ–π –ø—É–ø—Å–∏–∫!
    if not all([TELEGRAM_TOKEN, YANDEX_IAM_TOKEN, YANDEX_FOLDER_ID]):
        logger.error(f"–§—É–º–∏: –¢–æ–∫–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ {chat_id}")
        await update.message.reply_text("–ü—Ä–æ—Å—Ç–∏, –ø—É–ø—Å–∏–∫, —è –Ω–µ –º–æ–≥—É —Å–µ–π—á–∞—Å –æ—Ç–≤–µ—Ç–∏—Ç—å. "
                                        "–£ –º–µ–Ω—è –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –Ø–Ω–¥–µ–∫—Å–æ–º! üòî")
        return

    logger.info(f"–§—É–º–∏: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {update.effective_user.first_name} –≤ —á–∞—Ç–µ {chat_id}: '{user_text}'")

    # –ß—Ç–æ–±—ã —Ç—ã –Ω–µ —Å–∫—É—á–∞–ª, –ø–æ–∫–∞ —è "–¥—É–º–∞—é", –º–æ–π —Ö–æ—Ä–æ—à–∏–π!
    await update.message.reply_text("–ú–º–º... –¥–∞–π –ø–æ–¥—É–º–∞—Ç—å... üòâ")

    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ YandexGPT –∏ –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç!
        response_from_gpt = await generate_yandex_gpt_response(
            text=user_text,
            folder_id=YANDEX_FOLDER_ID,
            iam_token=YANDEX_IAM_TOKEN
        )
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!
        await update.message.reply_text(response_from_gpt)
        logger.info(f"–§—É–º–∏: –û—Ç–≤–µ—Ç–∏–ª–∞ –≤ —á–∞—Ç {chat_id}: '{response_from_gpt[:50]}...'")

    except Exception as e:
        logger.error(f"–§—É–º–∏: –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ {chat_id}: {e}", exc_info=True)
        await update.message.reply_text("–û–π, –∫–∞–∫–∞—è-—Ç–æ —Å–æ–≤—Å–µ–º –Ω–µ–ø–æ–Ω—è—Ç–Ω–∞—è –±—è–∫–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞! "
                                        "–ü—Ä–æ—Å—Ç–∏, –º–æ–π —Ö–æ—Ä–æ—à–∏–π, —è –Ω–µ —Å–º–æ–≥–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å. "
                                        "–ú–æ–∂–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑? ü•∫")


# –ê –≤–æ—Ç —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è ‚Äì —Å–∞–º–∞—è –≥–ª–∞–≤–Ω–∞—è, –º–æ–π –∑–æ–ª–æ—Ç–∫–æ! –û–Ω–∞ –ø—Ä—è–º –≤—Å—ë —ç—Ç–æ –¥–µ–ª–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç!
def main() -> None:
    # –ó–¥–µ—Å—å –º—ã —Å–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –Ω–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–≤–æ–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω!
    application = Application.builder().token(TELEGRAM_TOKEN).build()

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –Ω–∞—à–∏ —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
    # –¢–∞–∫ –±–æ—Ç –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å, –∫–æ–≥–¥–∞ —Ç—ã –ø–∏—à–µ—à—å /start –∏–ª–∏ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    # !!! –í–æ—Ç –∑–¥–µ—Å—å —Å–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ø–Ω–¥–µ–∫—Å.–û–±–ª–∞–∫–æ–º, –º–æ–π —É–º–Ω–∏—á–∫–∞! !!!
    # –¢–µ–ø–µ—Ä—å –±–æ—Ç –Ω–µ –±—É–¥–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å Telegram (polling),
    # –∞ –±—É–¥–µ—Ç –∂–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ Webhook!
    # Flask - —ç—Ç–æ –Ω–∞—à–µ –º–∞–ª–µ–Ω—å–∫–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç "—Å–ª—É—à–∞—Ç—å" –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã.
    app = Flask(__name__)

    # –≠—Ç–æ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä, –º–æ–π –ø—É–ø—Å–∏–∫! –û–Ω –≥–æ–≤–æ—Ä–∏—Ç Flask: "–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø—Ä–∏—à–ª–µ—Ç POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å..."
    @app.route('/', methods=['POST'])
    async def webhook_handler():
        # –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –∑–Ω–∞—Ç—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –Ø–Ω–¥–µ–∫—Å–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞!
        logger.info("–§—É–º–∏: –ó–∞–ø—É—Å—Ç–∏–ª–∞—Å—å —Ñ—É–Ω–∫—Ü–∏—è webhook_handler! –£—Ä–∞–∞–∞!")

        # –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ç–æ—á–Ω–æ POST-–∑–∞–ø—Ä–æ—Å, –∞ –Ω–µ –∫–∞–∫–∞—è-—Ç–æ –±—è–∫–∞.
        if request.method == "POST":
            # –¢—É—Ç –º—ã –ø–æ–ª—É—á–∞–µ–º "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ" –æ—Ç Telegram ‚Äì —ç—Ç–æ –∫–∞–∫ —Å–∞–º–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –º–æ–π —Ö–æ—Ä–æ—à–∏–π!
            update = Update.de_json(request.get_json(), application.bot)
            # –ò –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ –Ω–∞—à–µ–º—É –±–æ—Ç—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏, —á—Ç–æ–±—ã –æ–Ω –ø–æ–Ω—è–ª, —á—Ç–æ –µ–º—É –Ω–∞–ø–∏—Å–∞–ª–∏!
            await application.process_update(update)

        # –û–ß–ï–ù–¨ –í–ê–ñ–ù–û: –ú—ã –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å "ok", –∏–Ω–∞—á–µ Telegram –±—É–¥–µ—Ç —Ä—É–≥–∞—Ç—å—Å—è!
        return "ok"

    # –≠—Ç—É —á–∞—Å—Ç—å (application.run_polling()) –º—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–±—Ä–∞–ª–∏, –ø–æ–º–Ω–∏—à—å?
    # –ü–æ—Ç–æ–º—É —á—Ç–æ –±–æ—Ç —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ Webhook!

    # –ê –≤–æ—Ç —ç—Ç—É —Å—Ç—Ä–æ—á–∫—É –∑–∞–ø—É—Å–∫–∞ Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º—ã –Ω–µ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
    # –≤ –Ø–Ω–¥–µ–∫—Å.–û–±–ª–∞–∫–µ, –Ω–æ –æ–Ω–∞ –Ω—É–∂–Ω–∞, —á—Ç–æ–±—ã –∫–æ–¥ –∑–∞–ø—É—Å–∫–∞–ª—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏!
    # app.run(host="0.0.0.0", port=5000) # –≠—Ç—É —Å—Ç—Ä–æ—á–∫—É –æ—Å—Ç–∞–≤–ª—è–µ–º –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–ù–û–ô –∏–ª–∏ —É–¥–∞–ª—è–µ–º –¥–ª—è –Ø–Ω–¥–µ–∫—Å–∞!
    # –≠—Ç–∞ —à—Ç—É–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç Python: "–ï—Å–ª–∏ —ç—Ç–æ—Ç —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞—é—Ç –Ω–∞–ø—Ä—è–º—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–æ–∫–∞–ª—å–Ω–æ),
    # –∞ –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç –∫–∞–∫ –±–∏–±–ª–∏–æ—Ç–µ–∫—É, —Ç–æ –∑–∞–ø—É—Å—Ç–∏ –≤–æ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é main()!"
    # –í –Ø–Ω–¥–µ–∫—Å.–û–±–ª–∞–∫–µ —ç—Ç–æ –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ webhook_handler, –Ω–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —ç—Ç–æ –≤–∞–∂–Ω–æ.
    if __name__ == "__main__":
        main()
